<!DOCTYPE html>
<html>
  <head>
    <title>pres</title>
    <meta charset="utf-8">
    <meta name="author" content="Amanda Dobbyn" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# pres
### Amanda Dobbyn

---





###  Warning: this presentation contains less rap than you might have expected. 

I won't blame you if you want to make a quick exit.

---

### Quick about me

Day job: ultimate frisbee player.

For fun: Data Scientist at Earlybird Software, former co-organizer of R-Ladies Chicago.

---

### `drake`'s main idea

`drake` is workflow manager for your R code.

In an R pipeline, when changes occur that make the most recent results out-of-date, rebuild *only* the parts of the pipeline that need to be rebuilt.

Created and maintained by [Will](https://twitter.com/wmlandau) [Landau](https://github.com/wlandau) and friends.

---

### What's the deal with the name?

**d**ataframes in **R** for M**ake**

[GNU Make](https://www.gnu.org/software/make/) uses workflow outline file called a Makefile to specify dependencies and how targets should be rebuilt when they're out of date. 

`drake` takes that idea and implements it in a way that's more native to how we work in R.

![example_makefile](img/example_makefile.jpg)

---

### Nice features of `drake`
1. See how your pipeline fits together, in a tidy dataframe
2. Visualize dependencies in your code in graph format
3. Some high-performance computing advantages
4. Great for iteration and reproducibility; you know exactly how these results were generated
5. It's all in R -- no writing config files!


You can avoid workflows like this, that are based on file names that could easily be out of date and rely on `source`ing the script before it.

`01_import.R`

`02_clean.R`

`03_deep_clean.R`

`04_join.R`

`05_analyze.R`

`06_analyze_more.R`

`07_report.Rmd`

If something breaks in `04_join.R`, do you need to go through `01_import.R`, `02_clean.R`, and `03_deep_clean.R` again?

---

### Analogy to `knitr`

(Stolen from Will's point in his [interview on the R podcast](https://www.youtube.com/watch?v=eJQ29CLyDCs&amp;feature=youtu.be&amp;t=1533).)

`drake` is sort of like `knitr` in the sense that 
1) It makes your analysis reproducible and compact. You expect to be able to rerun someone's report from a single file.

2) In `knitr`, chunks can be cached if they've already been run, so they don't need to be re-run unless something in them changes.

3) When an `Rmd` is knit, a chunk successfully knitting depends on the previous chunk knitting and on any chunk that you specify a [`depedson`](https://twitter.com/drob/status/738786604731490304?lang=en) for.

---

### A few pieces of vocab

#### *targets* and *commands*

From `?drake_config`: "**Targets** are the objects and files that drake generates, and **commands** are the pieces of R code that produce them."

---

### A few pieces of vocab

#### *plans*

**Plans** wrap up the relationship between targets and commands into a workflow representation.

In `drake` they're stored as a dataframe object, with one column for targets, and one column for their corresponding commands.

You can think of the plan as that top-level script that sources all the other scripts and runs everything, like


```r
source("01_import.R")
source("02_clean.R")
...
source("06_analyze_more.R")

final &lt;- do_more_things(object_in_env)

write_out_my_results(final)
```

except that it knows about the dependencies of all objects and functions and is less cumbersome than this setup.

---

### How to `drake`

1. Store prework (loading packages and user-defined functions) in a file 
2. Store a `drake` plan in another file
3. Create the plan and run it


```r
source("/path/to/my/prework.R")

## Custom functions defined in prework are:
# clean_my(), analyze_my(), and report_out_my()

plan &lt;- 
  drake_plan(
  cleaned_data = clean_my(raw_data),
  results = analyze_my(cleaned_data),
  report = report_out_my(results,
                         file_out = "/path/to/my/report.md")
)

make(plan)
```

The first run of `make(plan)` will run the plan from scratch. 

After that, `drake` will only re-run the parts of the plan that are out of date and everything downstream of that.

`drake` knows that, for example, `results` depends on `cleaned_data` because `cleaned_data` is part of the `analyze_my(cleaned_data)` command used to generate `results`.

---

### What makes a target become out of date?

1. Some part of the code used to generate that target or one of its upstream targets has changed
2. A trigger is activated (more on that later)

---

### Where is all this info stored?

**targets**

In a hidden `.drake` cache when you run `make()`. In the `.drake/data` subdirectory, targets are stored as hashed `rds` objects. [More on storage.](https://ropensci.github.io/drake/articles/storage.html)

`clean()` cleans that cache.

**dependencies**

`drake` stores a dependency graph (`igraph` object) of the plan along with a bunch of other things in `config`, which you can access with `drake_config()`.

---

### Big Idea #2

`drake` is all built around *functions* rather than sourcing scripts.
- A plan works by using functions to create targets. 
- This allows `drake` to infer dependencies of objects and functions
- Running `drake_plan` creates a dataframe relating each target to the function used to generate it.



```r
bad_plan &lt;- 
  drake_plan(
    first_target = source("import.R"),
    second_target = source("clean.R")
  )
```

Sourcing files breaks the dependency structure that makes `drake` useful. 

Instead, 


```r
source("all_my_funs.R")

good_plan &lt;- 
  drake_plan(
    first_target = do_stuff(my_data),
    second_target = do_more_stuff(first_target)
  )
```

This setup allows `drake` to know `first_target` needs to be built before work on `second_target` can begin.

---

### Other things `drake` can do that we won't get into

- [Generate ~ big plans ~](https://ropensci.github.io/drake/articles/best-practices.html#generating-workflow-plan-data-frames)

![big_plans](https://media.giphy.com/media/DCslYLxUUgKX2ms0iw/giphy.gif)

for analyses that require lots of different permutations of a similar analysis

(version 7.0.0 has new experimental syntax that makes it easier to create big plans)

- Support for [debugging and testing ](https://ropenscilabs.github.io/drake-manual/debug.html) plans

- Compatibility with [high performance computing](https://ropenscilabs.github.io/drake-manual/hpc.html) backends


### Moar Resources

- [`drake` user manual](https://ropenscilabs.github.io/drake-manual/index.html)
- [debugging drake](https://ropensci.github.io/drake/articles/debug.html)
- [Sina RÃ¼eger's `drake` presentation](https://sinarueeger.github.io/2018/10/09/workflow/)
- [Kirill MÃ¼ller's cheat sheet](https://github.com/krlmlr/drake-sib-zurich/blob/master/cheat-sheet.pdf)

---

### Our plan

I'll illustrate a way you might want to use `drake` with something that's close to home for us.

Remember the [crazy blue light](https://twitter.com/NYCFireWire/status/1078478369036165121) from late December?

The Twitter account that let us know that this wasn't in fact aliens is [NYCFireWire](https://twitter.com/NYCFireWire).

Normally they just tweet out fires and their locations in a more or less predictable pattern, i.e.

`&lt;borough&gt; &lt;** some numbers **&gt; &lt;address&gt; &lt;description of fire&gt;`

What if we were constructing an analysis of these tweets and wanted to make sure our pipeline worked end-to-end, but didn't want to unnecessarily re-run outdated parts of it unless we needed to?

---

### The Pipeline

1. Pull in tweets, either the first big batch or any new ones that show up
2. Extract addresses from the tweets (ðŸŽ¶ regex time ðŸŽ¶)
3. Send addresses to the Google Maps API to grab their latitudes and longitudes
4. Profit

All functions stored in `didnt_start_it.R`.


```r
source(here::here("didnt_start_it.R"))
```


---

### Grabbing tweets

- `get_seed_tweets` grabs a batch of tweets *or* reads in seed tweets from a file if the file exists
- `get_more_tweets` checks if there are new tweets and, if so, pulls in the right number of them
- `get_tweets` runs `get_seed_tweets` if given a null `tbl` argument, otherwise runs `get_more_tweets`




```r
get_tweets()
```

```
## # A tibble: 50 x 5
##    text                   user_id status_id created_at          screen_name
##    &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt; &lt;dttm&gt;              &lt;chr&gt;      
##  1 Queens *Water Rescue*â€¦  5.60e8   1.09e18 2019-01-27 17:21:23 NYCFireWire
##  2 Brooklyn *77-75-2597*â€¦  5.60e8   1.09e18 2019-01-27 16:10:36 NYCFireWire
##  3 Brooklyn *77-75-0805*â€¦  5.60e8   1.09e18 2019-01-27 11:36:52 NYCFireWire
##  4 Staten Island *88-75-â€¦  5.60e8   1.09e18 2019-01-27 11:10:49 NYCFireWire
##  5 Brooklyn *77-75-0689*â€¦  5.60e8   1.09e18 2019-01-27 01:36:24 NYCFireWire
##  6 The FDNYâ€™s diversity â€¦  5.60e8   1.09e18 2019-01-27 01:12:13 NYCFireWire
##  7 Fairfax County Fire &amp;â€¦  5.60e8   1.09e18 2019-01-27 01:11:39 NYCFireWire
##  8 https://t.co/dnYTm4ZAâ€¦  5.60e8   1.09e18 2019-01-26 23:06:02 NYCFireWire
##  9 Queens *99-75-6833* 1â€¦  5.60e8   1.09e18 2019-01-26 21:05:04 NYCFireWire
## 10 Queens *99-75-4187* 5â€¦  5.60e8   1.09e18 2019-01-26 20:14:02 NYCFireWire
## # â€¦ with 40 more rows
```

---

### Grabbing tweets

The most recent tweets from NYCFireWire:


```r
get_tweets() %&gt;% 
  select(text) %&gt;% 
  print(n = nrow(.))
```

```
## # A tibble: 50 x 1
##    text                                                                    
##    &lt;chr&gt;                                                                   
##  1 Queens *Water Rescue* Howard Beach Motor Boat Club. Person fell off theâ€¦
##  2 Brooklyn *77-75-2597* 785 E 4th St off Avenue F. Fire 4th floor.        
##  3 Brooklyn *77-75-0805* 1259 Madison St. Fire on 2nd fl                   
##  4 Staten Island *88-75-0460* 280 Park Hill Ave off Sobel ct. Fire in an 8â€¦
##  5 Brooklyn *77-75-0689* 188 Garvey Blvd. Fire in a 4 story multiple dwellâ€¦
##  6 The FDNYâ€™s diversity monitor has cost the city $23 million in 7 years hâ€¦
##  7 Fairfax County Fire &amp;amp; Rescue are hiring. https://t.co/LdaKIjnOIB    
##  8 https://t.co/dnYTm4ZAAU                                                 
##  9 Queens *99-75-6833* 115-87 229 St. Basement fire private dwelling. E-31â€¦
## 10 Queens *99-75-4187* 54-02 Flushing Ave. Fire 1st floor chinese restauraâ€¦
## 11 Queens *99-75-5692* 99-43 213 St. x 102 Ave. Fire in a private dwelling 
## 12 Queens *99-75-5692* 99-43 213 St. House fire. Bed ridden person trappedâ€¦
## 13 Brooklyn *77-22-2743**2nd Alarm** 1859 Nostrand Ave. Basement fire in aâ€¦
## 14 Brooklyn *77-75-2743* 1859 Nostrand Ave. Basement fire in a store.      
## 15 Someone with a box cutter walked up to the ambulance and did this.... aâ€¦
## 16 Queens *99-75-9340* 42-03 108 St. Fire in a private dwelling            
## 17 Bronx *66-75-3933* 5631 Post Rd. Attic fire private dwelling. E-52/L-52â€¦
## 18 De Blasio Defends Big Gap in Pay Separating EMS From Cops, Fire https:/â€¦
## 19 Bronx *66-75-4846* 685 E 237 St. Fire in a private dwelling             
## 20 https://t.co/NHtiYI55vp                                                 
## 21 Bronx *66-75-2929* 1668 Montgomery Ave. Fire 2nd floor                  
## 22 Another criminal gets to walk. God bless the #NYPD. #FDNYPD #ProtectTheâ€¦
## 23 Bronx *66-75-2375* 1023 Bruckner Blvd. Fire 1st floor taxpayer in a 5 sâ€¦
## 24 Queens *99-75-4746* 163-56 25 Dr. Fire in a private dwelling.           
## 25 Queens **99-44-4763**4th Alarm*** 114-39 157 St. 3 houses on fire       
## 26 Queens **99-33-4763**3rd Alarm*** 114-39 157 St. 3 houses on fire. E-30â€¦
## 27 Queens *99-75-8644* 117-41 164 St. Fire in a private dwelling. All Handâ€¦
## 28 Bronx *66-75-2577* 1200 Woodycrest Ave off W 167 St. Fire apt 6D 6 storâ€¦
## 29 Welcome back! https://t.co/CaVeK3NG0o                                   
## 30 Manhattan *66-75-1630* 1724 Amsterdam Ave off W 146 St. Fire 2nd floor â€¦
## 31 Staten Island **88-22-0227**2nd Alarm** 192 Victory Blvd off Pike St. Eâ€¦
## 32 Staten Island **88-22-0227**2nd Alarm** 192 Victory Blvd off Pike St. Fâ€¦
## 33 Staten Island *88-22-0227**2nd Alarm** 192 Victory Blvd off Pike St. Hoâ€¦
## 34 Staten Island *88-75-0227* 192 Victory Blvd off Pike St. House fire. E-â€¦
## 35 Brooklyn *77-75-0757* 108 Himrod St off Central Ave. Fire in the cockloâ€¦
## 36 Brooklyn *77-75-2280* 1407 E 92 St. Fire 1st floor rear setback         
## 37 Queens *99-75-3124* 80-44 Cornish Ave off Queens Blvd. Fire in a 3 storâ€¦
## 38 Brooklyn *77-75-3514* 3709 Laurel ave off of seagate ave.               
## 39 Brooklyn *77-75-2306* 249 E 52 St. Fire private dwelling. Snyder Islandâ€¦
## 40 Why wasn't this considered when the plans were reviewed to start this pâ€¦
## 41 "Hudson Yards developer Stephen Ross owns a lot of expensive things, inâ€¦
## 42 It's with Regret we announce the passing of Active Firefighter &amp;amp; UFâ€¦
## 43 Manhattan *66-75-1188* 224 E 89 St. Fire apt 3 in a 5 story 25x75.      
## 44 Staten Island *88-75-2049* 204 Boundary Ave. Private dwelling           
## 45 Another one caught! https://t.co/jpwguHFVjw                             
## 46 Brooklyn *77-75-1986* 1753 Linden Blvd. Bn-58 transmitting the 10-75, 2â€¦
## 47 Queens *99-75-7899* 35-30 91 St. Basement fire 2 1/2 story private dwelâ€¦
## 48 Brooklyn *77-75-3137* 1270 E 51 St. Fire 2nd floor 7 story multiple dweâ€¦
## 49 Queens *99-75-1122* 14-37 Eggert Pl. Fire in a vacant private dwelling. 
## 50 Queens *99-33-9368**3rd alarm** 34-40 100 St. Heavy fire conditions in â€¦
```


---

### Grabbing tweets

Starting with an old tweet ID, we can first grab a 10 tweets older than `old_tweet_id` and then, running the same function again, add 5 of the most recent tweets to our dataframe.


```r
old_tweet_id &lt;- "1084619203167031297" # Random tweet from a while ago so what we can set a max id in the past

seed_tweets &lt;- 
  get_tweets(
    n_tweets_seed = 10,
    max_id = old_tweet_id
  )

(full_tweets &lt;- 
  get_tweets(seed_tweets, n_tweets_reup = 5))
```

```
## Searching for new tweets.
```

```
## 5 new tweet(s) pulled.
```

```
## # A tibble: 15 x 5
##    text                   user_id status_id created_at          screen_name
##    &lt;chr&gt;                    &lt;dbl&gt;     &lt;dbl&gt; &lt;dttm&gt;              &lt;chr&gt;      
##  1 Queens *Water Rescue*â€¦  5.60e8   1.09e18 2019-01-27 17:21:23 NYCFireWire
##  2 Brooklyn *77-75-2597*â€¦  5.60e8   1.09e18 2019-01-27 16:10:36 NYCFireWire
##  3 Brooklyn *77-75-0805*â€¦  5.60e8   1.09e18 2019-01-27 11:36:52 NYCFireWire
##  4 Staten Island *88-75-â€¦  5.60e8   1.09e18 2019-01-27 11:10:49 NYCFireWire
##  5 Brooklyn *77-75-0689*â€¦  5.60e8   1.09e18 2019-01-27 01:36:24 NYCFireWire
##  6 "Staten Island *MVA/Pâ€¦  5.60e8   1.08e18 2019-01-13 20:12:23 NYCFireWire
##  7 Queens 99-75-6810 111â€¦  5.60e8   1.08e18 2019-01-13 17:57:22 NYCFireWire
##  8 Manhattan *66-75-1352â€¦  5.60e8   1.08e18 2019-01-13 04:27:44 NYCFireWire
##  9 Staten Island *88-75-â€¦  5.60e8   1.08e18 2019-01-13 03:15:46 NYCFireWire
## 10 Firefighter in harassâ€¦  5.60e8   1.08e18 2019-01-12 22:10:35 NYCFireWire
## 11 Mom whose tot startedâ€¦  5.60e8   1.08e18 2019-01-12 21:33:46 NYCFireWire
## 12 Much love &amp;amp; appreâ€¦  5.60e8   1.08e18 2019-01-12 19:24:44 NYCFireWire
## 13 FCC: New York is siphâ€¦  5.60e8   1.08e18 2019-01-12 17:09:36 NYCFireWire
## 14 God bless the #NYPD hâ€¦  5.60e8   1.08e18 2019-01-12 16:46:34 NYCFireWire
## 15 Pregnant FDNY worker â€¦  5.60e8   1.08e18 2019-01-12 09:12:38 NYCFireWire
```

---

### Getting addresses




```r
get_tweets() %&gt;% 
  pull_addresses() %&gt;% 
  select(street, borough, address, text)
```

```
## Source: local data frame [50 x 4]
## Groups: &lt;by row&gt;
## 
## # A tibble: 50 x 4
##    street         borough   address              text                      
##    &lt;chr&gt;          &lt;chr&gt;     &lt;chr&gt;                &lt;chr&gt;                     
##  1 Howard Beach â€¦ Queens    Howard Beach Motor â€¦ Queens *Water Rescue* Howâ€¦
##  2 785 E 4th St â€¦ Brooklyn  785 E 4th St off Avâ€¦ Brooklyn *77-75-2597* 785â€¦
##  3 1259 Madison â€¦ Brooklyn  1259 Madison St, Brâ€¦ Brooklyn *77-75-0805* 125â€¦
##  4 280 Park Hillâ€¦ Staten Iâ€¦ 280 Park Hill Ave oâ€¦ Staten Island *88-75-0460â€¦
##  5 188 Garvey Blâ€¦ Brooklyn  188 Garvey Blvd, Brâ€¦ Brooklyn *77-75-0689* 188â€¦
##  6 &lt;NA&gt;           &lt;NA&gt;      &lt;NA&gt;                 The FDNYâ€™s diversity moniâ€¦
##  7 &lt;NA&gt;           &lt;NA&gt;      &lt;NA&gt;                 Fairfax County Fire &amp;amp;â€¦
##  8 &lt;NA&gt;           &lt;NA&gt;      &lt;NA&gt;                 https://t.co/dnYTm4ZAAU   
##  9 115-87 229 St  Queens    115-87 229 St, Queeâ€¦ Queens *99-75-6833* 115-8â€¦
## 10 54-02 Flushinâ€¦ Queens    54-02 Flushing Ave,â€¦ Queens *99-75-4187* 54-02â€¦
## # â€¦ with 40 more rows
```

---

### Getting lat and long

Then we can use the [`geocode`](https://www.rdocumentation.org/packages/ggmap/versions/2.6.1/topics/geocode) function (along with a [Google Maps](https://cloud.google.com/maps-platform/) API key) from the `ggmap` package to attach the latitude and longitude to each address, if Google can find it. (Otherwise we're returned `NA`s.)




```r
get_tweets(n_tweets_seed = 5) %&gt;% 
  pull_addresses() %&gt;% 
  get_lat_long()
```

```
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=Howard%20Beach%20Motor%20Boat%20Club%2C%20Queens&amp;key=xxx
```

```
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=785%20E%204th%20St%20off%20Avenue%20F%2C%20Brooklyn&amp;key=xxx
```

```
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=1259%20Madison%20St%2C%20Brooklyn&amp;key=xxx
```

```
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=280%20Park%20Hill%20Ave%20off%20Sobel%20ct%2C%20Staten%20Island&amp;key=xxx
```

```
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=188%20Garvey%20Blvd%2C%20Brooklyn&amp;key=xxx
```

```
## # A tibble: 5 x 7
##   address      lat  long lat_trunc long_trunc created_at          text     
##   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;dttm&gt;              &lt;chr&gt;    
## 1 Howard Beâ€¦  40.7 -73.8      40.7      -73.8 2019-01-27 17:21:23 Queens *â€¦
## 2 785 E 4thâ€¦  40.6 -74.0      40.6      -74   2019-01-27 16:10:36 Brooklynâ€¦
## 3 1259 Madiâ€¦  40.7 -73.9      40.7      -73.9 2019-01-27 11:36:52 Brooklynâ€¦
## 4 280 Park â€¦  40.6 -74.1      40.6      -74.1 2019-01-27 11:10:49 Staten Iâ€¦
## 5 188 Garveâ€¦  40.7 -73.9      40.7      -73.9 2019-01-27 01:36:24 Brooklynâ€¦
```


That's our main pipeline. We can do a few bits of analysis of the data after that, but that's the core of it.

---

### Live coding time!

We'll first test our reupping scheme with a ðŸ”¥ burner account ðŸ”¥

The `rtweet` package also supports posting tweets, so we can test out whether our trigger successfully pulls in new tweet by posting ourselves with a

**[burner account!](https://twitter.com/didntstartit)**
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>

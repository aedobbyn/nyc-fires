<!DOCTYPE html>
<html>
  <head>
    <title>drake for Workflow Happiness in R</title>
    <meta charset="utf-8">
    <meta name="author" content="Amanda Dobbyn" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/shinobi.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# <code>drake</code> for Workflow Happiness in R
### Amanda Dobbyn

---





###  Warning: this presentation contains less rap than you might have expected. 

--

&lt;br&gt;

I won't blame you if you want to make a quick getaway.

.center[![grandpasimpson](https://media.giphy.com/media/11gC4odpiRKuha/giphy.gif)]

---

class: inverse

## Quick about me

.pull-right[![](./img/fris.jpg)]

&lt;br&gt;

**Day job**: ultimate frisbee player.



**For fun**: Data Scientist at Earlybird Software, former co-organizer of [R-Ladies Chicago](https://rladieschicago.org/).

&lt;!-- .pull-left[![](./img/pingpong.jpg)] --&gt;

GitHub: https://github.com/aedobbyn

Website: https://dobb.ae

Twitter: [@dobbleobble](https://twitter.com/dobbleobble)

---

## Overview

I'll give an intro to what `drake` is and how it works.

Then we'll switch to a [live coding Rmd](https://github.com/aedobbyn/nyc-fires/blob/master/live_code.md) which hopefully won't totally break.

In that part, we'll use the Twitter and Google Maps geocoding APIs to run a `drake` pipeline.

---

## `drake`'s main idea

[`drake`](https://github.com/ropensci/drake) is workflow manager for your R code.

*What that means*: 

In an R pipeline, when changes occur that make the most recent results **out-of-date**, `drake` rebuilds *only* the parts of the pipeline that need to be rebuilt.

&lt;p align="center"&gt;
&lt;img src="https://media.giphy.com/media/JFawGLFMCJNDi/giphy.gif" alt="ilovechanges"&gt;
&lt;/p&gt;

Created and maintained by [Will](https://twitter.com/wmlandau) [Landau](https://github.com/wlandau) and friends.

---

## What's the deal with the name?

--

### **d**ataframes in **R** for M**ake**

&lt;br&gt;

--

.pull-left[

What's Make?

[GNU Make](https://www.gnu.org/software/make/) is a tool that uses file called a Makefile to specify **dependencies** in a pipeline. 

`drake` takes that idea and implements it in a way that's more native to how we work in R.

]

Example of a Makefile:

.pull-right[![example_makefile](./img/example_makefile_r.jpg)]

---

## Nice features of `drake`


.pull-left[

1) See how your pipeline fits together, in a tidy **dataframe**

&lt;br&gt;

]

--

2) Visualize the **dependency graph** of your code


.pull-right[![](./img/iris_dependency_graph.jpg)] 

&lt;br&gt;
&lt;br&gt;

--

.pull-left[

3) Great for iteration and **reproducibility**; you know exactly how these results were generated 

]

&lt;br&gt;
&lt;br&gt;

--

.pull-left[

4) High-performance computing advantages

]

&lt;br&gt;
&lt;br&gt;

--

.pull-left[

5) It's all in R so no writing config files! üéâ

&lt;br&gt;

]

&lt;!-- .pull-right[![](./img/mtcars_dependency_graph.jpg)] --&gt;

---

class: inverse

## Better workflows

.pull-left[

Does your analysis directory look like this?

`01_import.R`

`02_clean.R`

`03_deep_clean.R`

`04_join.R`

`05_analyze.R`

`06_analyze_more.R`

`07_report.Rmd`
]

.pull-right[

- Depends on correctly `source`ing the script before it. Need:
  - Up-to-date file names
  - Same input data
  - Everything working correctly and in the right order


- If something breaks
  - Can you be sure about where it broke?
  - Do you need to re-run the entire pipeline again? 
]



---

### `drake` : `knitr`

(Analogy stolen from Will's point in his [interview on the R podcast](https://www.youtube.com/watch?v=eJQ29CLyDCs&amp;feature=youtu.be&amp;t=1533).)

![tiny_hats](./img/tiny_hats.jpg)

--


1) `knitr` can **cache** chunks if they've already been run, and nothing in them has changed.

--

2) A chunk successfully knitting **depends** on the previous chunk knitting and on any chunk that you specify a [`depedson`](https://twitter.com/drob/status/738786604731490304?lang=en) for.

--

3) It lives in a single file, making your analysis reproducible and **compact**. 




???
With knitr, you expect to be able to rerun someone's report from a single file.

---

## Is this also kinda like memoising?

--

Yes!

--

But better.

--

Memoising (in R implemented nicely in the [`memoise` package](https://github.com/r-lib/memoise)):

**caches the return value of a function given a set of arguments**

- if that function is called again with the *same* set of arguments, we pull the return value from the cache rather than recomputing it --&gt; saves time üëç

--

The downside:

**Memoising only applies to one function.**

What if a function upstream of the memoised function changes? We could get the wrong answer. üëé

---

## On Memoising


```r
add &lt;- function(a, b) {
  a + b
}

add_and_square &lt;- function(a, b) {
  add(a, b) ^ 2
}
```

--


```r
add(2, 3)
## [1] 5
add_and_square(2, 3)
## [1] 25
```


---

## On Memoising

If we've memoised `add_and_square`,


```r
add_and_square &lt;- memoise::memoise(add_and_square)
```

we return `add_and_square(2, 3)` from the cache rather than computing it. (Yay, fast!)


```r
add_and_square(2, 3)
## [1] 25
```

&lt;br&gt;

--

**But** if we now redefine `add` so that it *subtracts* `b` from `a`...

```r
add &lt;- function(a, b) {
  a - b
}
```


--

What will happen when we call `add_and_square(2, 3)`?

---

## On Memoising

--

We should get

```r
add(2, 3) ^ 2
## [1] 1
```

--

But instead we return the old answer, which is now wrong:


```r
add_and_square(2, 3)
## [1] 25
```

--

&lt;br&gt;

Luckily, `drake` knows the *all* the dependency relationships between functions and files as they relate to your targets.

So, `drake` would know that the definition of `add` has changed, meaning that `add_and_square(2, 3)` needs to be recomputed.

---

class: inverse

## A few pieces of vocab

&lt;br&gt;

**Targets** are the objects and files that drake generates;

&lt;br&gt;

--

**Commands** are the pieces of R code that produce them.

&lt;br&gt;

--

**Plans** wrap up the relationship between targets and commands into a workflow representation: a dataframe.

&lt;br&gt;

???

one column for targets, and one column for their corresponding commands.

---

## More on plans

Plans are like that top-level script that runs your entire pipeline.

&lt;br&gt;


```r
source("01_import.R")
source("02_clean.R")
...
source("06_analyze_more.R")

final &lt;- do_more_things(object_in_env)

write_out_my_results(final)
```

&lt;br&gt;

*But*, a plan **knows about the dependencies** in your code.


---

## How to `drake`

--

&lt;br&gt;

1) Store **prework** (your functions and any packages you need to load) in a file 

`prework.R`


--

2) Store a `drake` **plan** in another file


```r
plan &lt;- 
  drake_plan(
    cleaned_data = clean_my(raw_data),
    results = analyze_my(cleaned_data),
    report = report_out_my(results)
  )
```


--

3) **Run** the plan



```r
make(plan)
```

---

## What `drake does`


```r
plan &lt;- 
  drake_plan(
    cleaned_data = clean_my(raw_data),
    results = analyze_my(cleaned_data),
    report = report_out_my(results)
  )
```

--

`drake_plan` stores your plan as targets and commands in a dataframe.

--


```r
plan
## # A tibble: 3 x 2
##   target       command                 
##   &lt;chr&gt;        &lt;chr&gt;                   
## 1 cleaned_data clean_my(raw_data)      
## 2 results      analyze_my(cleaned_data)
## 3 report       report_out_my(results)
```


---

## What `drake does`


```r
plan &lt;- 
  drake_plan(
    cleaned_data = clean_my(raw_data),
    results = analyze_my(cleaned_data),
    report = report_out_my(results)
  )
```



```r
make(plan)
```


## What `drake does`

**First run** of `make(plan)`:

`drake` runs the plan from scratch

&lt;br&gt;

**Thereafter**:

`drake` will only rebuild targets that are out of date, and everything downstream of them



---

## What makes a target become out of date?

1) A trigger is activated (more on these later)


--

2) Something used to generate that target *or one of its upstream targets* has changed

--


```r
plan
## # A tibble: 3 x 2
##   target       command                 
##   &lt;chr&gt;        &lt;chr&gt;                   
## 1 cleaned_data clean_my(raw_data)      
## 2 results      analyze_my(cleaned_data)
## 3 report       report_out_my(results)
```


`drake` knows that`results` depends on the object `cleaned_data` and the function `analyze_my()`

because those are both part of the command used to generate `results`.

&lt;br&gt;

**So, if `cleaned_data` changes or `analyze_my` changes, `results` is out of date.**


---

## Where is all this info stored?

**targets**

In a hidden `.drake` directory, or cache. (You can check that it's there with `ls -a`.) [More on storage.](https://ropensci.github.io/drake/articles/storage.html)

`loadd()` loads targets from the cache into your R session.

`clean()` cleans the cache. (You can recover a cache if you clean it by accident.)

&lt;br&gt;

--

**dependencies**

`drake` hashes a target's dependencies to know when one of those dependencies changes, invalidating the target. 
You have [control](https://ropensci.github.io/drake/articles/storage.html#hash-algorithms) over the hashing algorithm used, location of the cache, etc.

`drake` stores a dependency graph (`igraph` object) of the plan along with a bunch of other things in a `config`.

You can access all of this with `drake_config()`.

---

class: inverse

## It's all about Functions

`drake` is all built around *functions* rather than scripts.

&lt;br&gt;

--

- A plan works by using functions to create targets

--

&lt;br&gt;

- This allows `drake` to infer **dependencies** between
  - objects and functions
  - functions and other functions

--

&lt;br&gt;

- Running `drake_plan` creates a dataframe relating each target to the command used to generate it

---

## All about Functions




```r
bad_plan &lt;- 
  drake_plan(
    first_target = source("import.R"),
    second_target = source("clean.R")
  )
```

--

Sourcing files breaks the dependency structure that makes `drake` useful. 

--

Instead, 


```r
source("all_my_funs.R")

good_plan &lt;- 
  drake_plan(
    first_target = do_stuff(my_data),
    second_target = do_more_stuff(first_target)
  )
```

Now `drake` knows`first_target` needs to be built before work on `second_target` can begin.

---

## Other things `drake` can do that we won't get into

- [Generate ~ big plans ~](https://ropensci.github.io/drake/articles/best-practices.html#generating-workflow-plan-data-frames)

.center[![big_plans](https://media.giphy.com/media/DCslYLxUUgKX2ms0iw/giphy.gif)]

for analyses that require lots of different permutations of a certain analysis.

(`drake` version 7.0.0 has a [new syntax](https://ropenscilabs.github.io/drake-manual/plans.html#create-large-plans-the-easy-way) that makes it easier to create big plans.)

- Support for [debugging and testing ](https://ropenscilabs.github.io/drake-manual/debug.html) plans

- Compatibility with [high performance computing](https://ropenscilabs.github.io/drake-manual/hpc.html) backends

---

## Moar Resources

&lt;br&gt;

- [`drake` user manual](https://ropenscilabs.github.io/drake-manual/index.html)

&lt;br&gt;

- [debugging drake](https://ropensci.github.io/drake/articles/debug.html)

&lt;br&gt;

- [Kirill M√ºller's cheat sheet](https://github.com/krlmlr/drake-sib-zurich/blob/master/cheat-sheet.pdf)

&lt;br&gt;


- [Sina R√ºeger](https://sinarueeger.github.io/2018/10/09/workflow/) and [Christine Stawitz](https://github.com/cstawitz/RLadies_Sea_drake)'s `drake` presentations

&lt;br&gt;

- [Drake's Spotify station](https://open.spotify.com/artist/3TVXtAsR1Inumwj472S9r4)

---

background-image: url("https://static01.nyt.com/images/2018/12/29/nyregion/28xp-explosion-sub-print/28xp-explosion-sub-facebookJumbo.jpg)

## Our plan

Remember the [crazy blue light](https://twitter.com/NYCFireWire/status/1078478369036165121) from late December?

--

![](./img/blue_light.jpg)

--

Eeeek! üò±

---

## Our plan

.pull-right[![](./img/nyc_fire.jpg)]

The Twitter account that let us know that this wasn't in fact aliens is [NYCFireWire](https://twitter.com/NYCFireWire).

&lt;br&gt;

Normally they just tweet out fires and their locations in a more or less predictable pattern:

&lt;br&gt;

&lt;br&gt;

&lt;br&gt;

&lt;br&gt;

`&lt;borough&gt; ** &lt;some numbers&gt; ** &lt;address&gt; &lt;description of fire&gt;`

&lt;br&gt;


We can analyze these tweets to get some info on fires in NYC.


???

I'll illustrate a way you might want to use `drake` with something that's close to home for us.

What if we were constructing an analysis of these tweets and wanted to make sure our pipeline worked end-to-end, but didn't want to unnecessarily re-run outdated parts of it unless we needed to?


---

## The Pipeline

1. Pull in tweets, either the first big batch or any new ones that show up
2. Extract addresses from the tweets (üé∂ regex time üé∂)
3. Send addresses to the Google Maps API to grab their latitudes and longitudes
4. Profit

&lt;br&gt;

All functions stored in [`didnt_start_it.R`](https://github.com/aedobbyn/nyc-fires/blob/master/R/didnt_start_it.R), which we'll source in now.


```r
source(here::here("R", "didnt_start_it.R"))
```

--

&lt;br&gt;

**Caveats**

This analysis relies on the [rtweet](https://github.com/mkearney/rtweet) and [ggmap](https://github.com/dkahle/ggmap) packages.

To be able to run it in full you'll need a [Twitter API access token](https://rtweet.info/articles/auth.html) and [Google Maps Geocoding API key](https://developers.google.com/maps/documentation/geocoding/intro#Geocoding).

---

## Grabbing tweets

`get_tweets`

*Main idea*:
- builds up a file of the most recent set of tweets from a given account

*Details*:
- if neither file nor tbl supplied as arguments, grabs an initial seed batch of tweets
- if either is supplied, checks for new tweets and grabs them if any
- spits out the latest to the same file



Most recent tweets from NYCFireWire:

```r
get_tweets(n_tweets_seed = 3)
## # A tibble: 3 x 5
##   text                  user_id status_id   created_at          screen_name
##   &lt;chr&gt;                 &lt;chr&gt;   &lt;chr&gt;       &lt;dttm&gt;              &lt;chr&gt;      
## 1 https://t.co/Nd5r636‚Ä¶ 560024‚Ä¶ 1090638089‚Ä¶ 2019-01-30 10:49:18 NYCFireWire
## 2 Retired firefighters‚Ä¶ 560024‚Ä¶ 1090561341‚Ä¶ 2019-01-30 05:44:20 NYCFireWire
## 3 Queens *99-75-1326* ‚Ä¶ 560024‚Ä¶ 1090392701‚Ä¶ 2019-01-29 18:34:13 NYCFireWire
```

???

- `get_seed_tweets` grabs a batch of tweets *or* reads in seed tweets from a file if the file exists
- `get_more_tweets` checks if there are new tweets and, if so, pulls in the right number of them
- `get_tweets` runs `get_seed_tweets` if given a null `tbl` argument, otherwise runs `get_more_tweets`


---

## Grabbing seed tweets

A closer look at just the text of the tweets:


```r
get_tweets() %&gt;% 
  select(text) %&gt;% 
  kable(format = "html")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; https://t.co/Nd5r636LGB &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Retired firefighters take a stand after American flag destroyed in the East Village https://t.co/ZOtoo2UI10 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-1326* Hammel Houses 84-14 Rockaway Beach Bl. Compactor fire &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3046* 3602 Avenue J. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-1605* 1673 Carroll St. Fire top floor 2 story &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3646* 296 West end Ave off Orietal Blvd. Fire in a 3 story &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; We‚Äôll have a cure for cancer within a year, scientists claim https://t.co/wtiN92bdRz &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Someone got access to NNSS in Nevada. I was there last year taking the Rad/Nuc course. This is a heavily secured site. Not a good move. https://t.co/pCBIRIPUx9 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-1597* 260 Convent Ave. Fire 2nd floor. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-9625* 107-27 Atlantic Ave. Fire 2nd floor mixed occupancy. &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


---

## Reupping tweets

To show how `get_tweets` can start with a `tbl` of tweets and look for new ones

we'll grab 10 `seed_tweets` that are all older than an old tweet ID.

--

&lt;br&gt;


```r
old_tweet_id &lt;- "1084619203167031297" # Random tweet from a while ago so what we can set a max id in the past

seed_tweets &lt;- 
  get_tweets(
    n_tweets_seed = 10,
    max_id = old_tweet_id
  )

nrow(seed_tweets)
## [1] 10
```

---

## Reupping tweets

Using `seed_tweets` as an input to the same `get_tweets` function

we check for new tweets, and, if there are any, pull them in.


```r
full_tweets &lt;- 
  get_tweets(seed_tweets, 
             n_tweets_reup = 5)
## Searching for new tweets.
## 5 new tweet(s) pulled.
```

--


```r
nrow(seed_tweets)
## [1] 10
nrow(full_tweets)
## [1] 15
```


---

## Getting addresses

With `pull_addresses` we parse the text of the tweet to pull out borough and street and string them together into an address.




```r
get_tweets() %&gt;% 
  pull_addresses() %&gt;% 
  select(text, street, borough, address) %&gt;% 
  kable(format = "html")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; street &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; borough &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; address &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; https://t.co/Nd5r636LGB &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Retired firefighters take a stand after American flag destroyed in the East Village https://t.co/ZOtoo2UI10 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-1326* Hammel Houses 84-14 Rockaway Beach Bl. Compactor fire &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Hammel Houses 84-14 Rockaway Beach Bl &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Hammel Houses 84-14 Rockaway Beach Bl, Queens &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3046* 3602 Avenue J. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 3602 Avenue J &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 3602 Avenue J, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-1605* 1673 Carroll St. Fire top floor 2 story &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1673 Carroll St &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1673 Carroll St, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3646* 296 West end Ave off Orietal Blvd. Fire in a 3 story &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 296 West end Ave off Orietal Blvd &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 296 West end Ave off Orietal Blvd, Brooklyn &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; We‚Äôll have a cure for cancer within a year, scientists claim https://t.co/wtiN92bdRz &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Someone got access to NNSS in Nevada. I was there last year taking the Rad/Nuc course. This is a heavily secured site. Not a good move. https://t.co/pCBIRIPUx9 &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-1597* 260 Convent Ave. Fire 2nd floor. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 260 Convent Ave &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 260 Convent Ave, Manhattan &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-9625* 107-27 Atlantic Ave. Fire 2nd floor mixed occupancy. &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 107-27 Atlantic Ave &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 107-27 Atlantic Ave, Queens &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

## Getting lat and long

Final step of the main pipeline, now that we can pull addresses from tweets.

**Reverse geocoding** = getting latitude and longitude from an address.

The `ggmap` package exposes this feature of the [Google Maps](https://cloud.google.com/maps-platform/) API in their [`geocode`](https://www.rdocumentation.org/packages/ggmap/versions/2.6.1/topics/geocode) function.

If Google can't find the address, we return `NA`s.





```r
get_tweets(n_tweets_seed = 5) %&gt;% 
  pull_addresses() %&gt;% 
  get_lat_long()
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=Hammel%20Houses%2084-14%20Rockaway%20Beach%20Bl%2C%20Queens&amp;key=xxx
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=3602%20Avenue%20J%2C%20Brooklyn&amp;key=xxx
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=1673%20Carroll%20St%2C%20Brooklyn&amp;key=xxx
## # A tibble: 5 x 7
##   address      lat  long lat_trunc long_trunc created_at          text     
##   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;dttm&gt;              &lt;chr&gt;    
## 1 &lt;NA&gt;        NA    NA        NA         NA   2019-01-30 10:49:18 https://‚Ä¶
## 2 &lt;NA&gt;        NA    NA        NA         NA   2019-01-30 05:44:20 Retired ‚Ä¶
## 3 Hammel Ho‚Ä¶  40.6 -73.8      40.6      -73.8 2019-01-29 18:34:13 Queens *‚Ä¶
## 4 3602 Aven‚Ä¶  40.6 -73.9      40.6      -73.9 2019-01-29 16:08:36 Brooklyn‚Ä¶
## 5 1673 Carr‚Ä¶  40.7 -73.9      40.7      -73.9 2019-01-29 14:25:26 Brooklyn‚Ä¶
```


---

## Analysis chunks of the pipeline

Later in the pipeline we can join on some `ggplot2::map_data`


```r
(nyc &lt;-
  ggplot2::map_data("state", region = "new york") %&gt;%
  truncate_lat_long(digits = 1) %&gt;%
  as_tibble())
```


or `count_fires`, summing up the total number of fires per `lat`-`long` combo.


```r
count_fires &lt;- function(tbl) {
  tbl %&gt;%
    drop_na() %&gt;%
    group_by(lat, long) %&gt;%
    count()
}
```


---

## Quick benchmark

So where does `drake` really come in handy here?

We don't want to re-run the API pipeline every time we change a downstream analysis step.

--

&lt;br&gt;

What's the estimate of running the whole pipeline on a single tweet? 

--


```r
(our_bench &lt;-
  bench::mark({
    get_tweets(n_tweets_seed = 1) %&gt;% 
    pull_addresses() %&gt;% 
    get_lat_long()
    }) %&gt;% 
      as_tibble() %&gt;% 
      pull(median))
## [1] 326ms
```

???
We don't get any batch speedups because we send each tweet one by one to Google Maps

---

## Quick benchmark

Roughly how many **minutes** would the pipeline take for 3k tweets?


```r
(n_mins &lt;- 
   (as.numeric(our_bench) # Returns this in seconds
      * 3000)  # 3k tweets
       / 60 # 60 seconds in a minute
 ) 
## [1] 16.30758
```

&lt;br&gt;

All our downstream mapping and counting analysis depends on these trips to and from Twitter and Google.

If we tweak our code and want to make sure we can still run these downstream analyses on the most recent data,

`drake` will save us **16 minutes** of our lives *and* we'll still rest assured that our downstream targets have the most up to date data.


---

class: inverse

## Live coding time!

We'll set up the `drake` plan and run it for real. 

An exclusive sneak peek:


```r
plan &lt;-
  drake_plan(
    seed_fires = get_tweets(), 
    fires = target(
      command = get_tweets(tbl = seed_fires),
      trigger = trigger(condition = TRUE) # Always look for new tweets
    ),
    addresses = pull_addresses(fires), # Extract addresses from tweets
    lat_long = get_lat_long(addresses), # Send to Google for lat-longs
    dat = join_on_city_data(lat_long, nyc), # Join on the nyc coords
    fire_sums = count_fires(dat), # Sum up n fires per lat-long combo

    time_graph = graph_fire_times(dat),
    plot = plot_fire_sums(dat, nyc)
  )
```

---

## Questions so far?


```r
devtools::session_info()
## ‚îÄ Session info ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
##  setting  value                       
##  version  R version 3.5.2 (2018-12-20)
##  os       macOS Mojave 10.14          
##  system   x86_64, darwin15.6.0        
##  ui       RStudio                     
##  language (EN)                        
##  collate  en_US.UTF-8                 
##  ctype    en_US.UTF-8                 
##  tz       America/New_York            
##  date     2019-01-30                  
## 
## ‚îÄ Packages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
##  package     * version    date       lib
##  assertthat    0.2.0      2017-04-11 [1]
##  backports     1.1.3      2018-12-14 [1]
##  base64url     1.4        2018-05-14 [1]
##  bench         1.0.1      2018-06-06 [1]
##  bindr         0.1.1      2018-03-13 [1]
##  bindrcpp    * 0.2.2      2018-03-29 [1]
##  bitops        1.0-6      2013-08-17 [1]
##  broom         0.5.0      2018-07-17 [1]
##  callr         2.0.4      2018-05-15 [1]
##  cellranger    1.1.0      2016-07-27 [1]
##  cli           1.0.1      2018-09-25 [1]
##  colorspace    1.4-0      2019-01-13 [1]
##  crayon        1.3.4      2018-12-20 [1]
##  curl          3.3        2019-01-10 [1]
##  debugme       1.1.0      2017-10-22 [1]
##  desc          1.2.0      2018-05-01 [1]
##  devtools      2.0.1      2018-10-26 [1]
##  digest        0.6.18     2018-10-10 [1]
##  dplyr       * 0.7.8      2018-11-10 [1]
##  drake       * 6.2.1.9002 2019-01-29 [1]
##  emo           0.0.0.9000 2018-07-05 [1]
##  emojifont     0.5.2      2019-01-17 [1]
##  evaluate      0.11       2018-07-17 [1]
##  fansi         0.4.0      2018-12-20 [1]
##  forcats     * 0.3.0      2018-02-19 [1]
##  fs          * 1.2.6      2018-08-23 [1]
##  ggmap       * 2.7.904    2019-01-04 [1]
##  ggplot2     * 3.1.0      2018-10-25 [1]
##  glue        * 1.3.0      2018-07-17 [1]
##  gtable        0.2.0      2016-02-26 [1]
##  haven         1.1.2      2018-06-27 [1]
##  here        * 0.1        2017-05-28 [1]
##  highr         0.7        2018-06-09 [1]
##  hms           0.4.2      2018-03-10 [1]
##  htmltools     0.3.6      2017-04-28 [1]
##  htmlwidgets   1.2        2018-04-19 [1]
##  httpuv        1.4.5.1    2018-12-18 [1]
##  httr          1.4.0      2018-12-11 [1]
##  igraph        1.2.2      2018-07-27 [1]
##  jpeg          0.1-8      2014-01-23 [1]
##  jsonlite      1.6        2018-12-07 [1]
##  knitr       * 1.21       2018-12-10 [1]
##  later         0.7.3      2018-06-08 [1]
##  lattice       0.20-38    2018-11-04 [1]
##  lazyeval      0.2.1      2017-10-29 [1]
##  lubridate     1.7.4      2018-04-11 [1]
##  magrittr      1.5        2014-11-22 [1]
##  maps        * 3.3.0      2018-04-03 [1]
##  memoise       1.1.0      2018-10-26 [1]
##  mime          0.6        2018-10-05 [1]
##  modelr        0.1.2      2018-05-11 [1]
##  munsell       0.5.0      2018-06-12 [1]
##  nlme          3.1-137    2018-04-07 [1]
##  openssl       1.1        2018-11-15 [1]
##  packrat       0.4.9-10   2018-08-10 [1]
##  pillar        1.3.1.9000 2018-12-20 [1]
##  pkgbuild      1.0.2      2018-10-16 [1]
##  pkgconfig     2.0.2      2018-08-16 [1]
##  pkgload       1.0.2      2018-10-29 [1]
##  plyr          1.8.4      2016-06-08 [1]
##  png           0.1-7      2013-12-03 [1]
##  prettyunits   1.0.2      2015-07-13 [1]
##  processx      3.1.0      2018-05-15 [1]
##  profmem       0.5.0      2018-01-30 [1]
##  promises      1.0.1      2018-04-13 [1]
##  proto         1.0.0      2016-10-29 [1]
##  purrr       * 0.3.0      2019-01-27 [1]
##  R6            2.3.0      2018-10-04 [1]
##  Rcpp          1.0.0      2018-11-07 [1]
##  readr       * 1.3.1      2018-12-21 [1]
##  readxl        1.1.0.9000 2018-07-05 [1]
##  remotes       2.0.2      2018-10-30 [1]
##  RgoogleMaps   1.4.3      2018-11-07 [1]
##  rjson         0.2.20     2018-06-08 [1]
##  rlang         0.3.1      2019-01-08 [1]
##  rmarkdown     1.11       2018-12-08 [1]
##  rprojroot     1.3-2      2018-01-03 [1]
##  rstudioapi    0.7        2017-09-07 [1]
##  rtweet      * 0.6.8      2018-09-28 [1]
##  rvest         0.3.2      2016-06-17 [1]
##  scales        1.0.0      2018-08-09 [1]
##  servr         0.11       2018-10-23 [1]
##  sessioninfo   1.1.1      2018-11-05 [1]
##  showtext      0.6        2019-01-10 [1]
##  showtextdb    2.0        2017-09-11 [1]
##  storr         1.2.1      2018-10-18 [1]
##  stringi       1.2.4      2018-07-20 [1]
##  stringr     * 1.3.1      2018-05-10 [1]
##  sysfonts      0.8        2018-10-11 [1]
##  testthat    * 2.0.1      2018-10-13 [1]
##  tibble      * 2.0.1      2019-01-12 [1]
##  tidyr       * 0.8.2      2018-10-28 [1]
##  tidyselect  * 0.2.5      2018-10-11 [1]
##  tidyverse   * 1.2.1      2017-11-14 [1]
##  usethis       1.4.0      2018-08-14 [1]
##  utf8          1.1.4      2018-05-24 [1]
##  visNetwork    2.0.4      2018-06-14 [1]
##  withr         2.1.2      2018-03-15 [1]
##  xaringan      0.8        2018-10-23 [1]
##  xfun          0.4        2018-10-23 [1]
##  xml2          1.2.0      2018-01-24 [1]
##  yaml          2.2.0      2018-07-25 [1]
##  source                                  
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  Github (r-lib/crayon@74bee76)           
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.1)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  Github (ropensci/drake@953917b)         
##  Github (hadley/emo@02a5206)             
##  Github (GuangchuangYu/emojifont@f7ba3ec)
##  CRAN (R 3.5.0)                          
##  Github (brodieG/fansi@ab11e9c)          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  Github (dkahle/ggmap@4dfe516)           
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.1)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  Github (r-lib/memoise@99db7eb)          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  Github (rstudio/packrat@7d320b1)        
##  Github (r-lib/pillar@9cc3030)           
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.1)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  Github (tidyverse/readxl@be74f8f)       
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.2)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
##  CRAN (R 3.5.0)                          
## 
## [1] /Library/Frameworks/R.framework/Versions/3.5/Resources/library
```


---

class: inverse

## Live coding time!

The `rtweet` package also supports posting tweets, so we can test out whether our trigger successfully pulls in new tweet by posting ourselves with a

&lt;br&gt;

## üî• **[burner account!](https://twitter.com/didntstartit)** üî•

&lt;br&gt;

Okay on to [part 2](https://github.com/aedobbyn/nyc-fires/blob/master/live_code.md) after this message from our sponsor.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>

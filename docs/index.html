<!DOCTYPE html>
<html>
  <head>
    <title>drake for Workflow Happiness in R</title>
    <meta charset="utf-8">
    <meta name="author" content="Amanda Dobbyn" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/shinobi.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# <code>drake</code> for Workflow Happiness in R
### Amanda Dobbyn

---





###  Warning: this presentation contains less rap than you might have expected. 

--

&lt;br&gt;

I won't blame you if you want to make a quick getaway.

.center[![grandpasimpson](https://media.giphy.com/media/11gC4odpiRKuha/giphy.gif)]

---

class: inverse

## Quick about me

.pull-right[![](./img/fris.jpg)]

&lt;br&gt;

**Day job**: ultimate frisbee player.



**For fun**: Data Scientist at Earlybird Software, former co-organizer of [R-Ladies Chicago](https://rladieschicago.org/).

&lt;!-- .pull-left[![](./img/pingpong.jpg)] --&gt;

GitHub: https://github.com/aedobbyn

Website: https://dobb.ae

Twitter: [@dobbleobble](https://twitter.com/dobbleobble)

---

## Overview

I'll give an intro to what `drake` is and how it works.

Then we'll switch to a [live coding Rmd](https://github.com/aedobbyn/nyc-fires/blob/master/live_code.md) which hopefully won't totally break.

In that part, we'll use the Twitter and Google Maps geocoding APIs to run a `drake` pipeline.

---

## `drake`'s main idea

[`drake`](https://github.com/ropensci/drake) is workflow manager for your R code.

*What that means*: 

In an R pipeline, when changes occur that make the most recent results **out-of-date**, `drake` rebuilds *only* the parts of the pipeline that need to be rebuilt.

&lt;p align="center"&gt;
&lt;img src="https://media.giphy.com/media/JFawGLFMCJNDi/giphy.gif" alt="ilovechanges"&gt;
&lt;/p&gt;

Created and maintained by [Will](https://twitter.com/wmlandau) [Landau](https://github.com/wlandau) and friends.

---

## What's the deal with the name?

--

### **d**ataframes in **R** for M**ake**

--

.pull-left[

What's Make?

[GNU Make](https://www.gnu.org/software/make/) is a tool that uses file called a Makefile to specify **dependencies** and how targets should be rebuilt when they're out of date. 

`drake` takes that idea and implements it in a way that's more native to how we work in R.

]

Example of a Makefile:

.pull-right[![example_makefile](./img/example_makefile_r.jpg)]

---

## Nice features of `drake`
1. See how your pipeline fits together, in a tidy **dataframe**

--

2. Visualize the **dependency graph** of your code

--

3. Great for iteration and **reproducibility**; you know exactly how these results were generated 

--

4. High-performance computing advantages

--

5. It's all in R so no writing config files! ðŸŽ‰

---

class: inverse

## Better workflows

.pull-left[

Does your analysis directory look like this?

`01_import.R`

`02_clean.R`

`03_deep_clean.R`

`04_join.R`

`05_analyze.R`

`06_analyze_more.R`

`07_report.Rmd`
]

.pull-right[

- Depends on correctly `source`ing the script before it. Need:
  - Up-to-date file names
  - Same input data
  - Everything working correctly and in the right order


- If something breaks
  - Can you be sure about where it broke?
  - Do you need to re-run the entire pipeline again? 
]



---

### `drake` : `knitr`

(Analogy stolen from Will's point in his [interview on the R podcast](https://www.youtube.com/watch?v=eJQ29CLyDCs&amp;feature=youtu.be&amp;t=1533).)

![tiny_hats](./img/tiny_hats.jpg)

--


1) `knitr` can **cache** chunks if they've already been run, and nothing in them has changed.

--

2) A chunk successfully knitting **depends** on the previous chunk knitting and on any chunk that you specify a [`depedson`](https://twitter.com/drob/status/738786604731490304?lang=en) for.

--

3) It lives in a single file, making your analysis reproducible and **compact**. 




???
With knitr, you expect to be able to rerun someone's report from a single file.

---

## A few pieces of vocab

&lt;br&gt;

**Targets** are the objects and files that drake generates;

&lt;br&gt;

--

**Commands** are the pieces of R code that produce them.

&lt;br&gt;

--

**Plans** wrap up the relationship between targets and commands into a workflow representation: a dataframe.

&lt;br&gt;

???

one column for targets, and one column for their corresponding commands.

---

## More on plans

Plans are like that top-level script that runs your entire pipeline.

&lt;br&gt;


```r
source("01_import.R")
source("02_clean.R")
...
source("06_analyze_more.R")

final &lt;- do_more_things(object_in_env)

write_out_my_results(final)
```

&lt;br&gt;

*But*, a plan **knows about the dependencies** in your code.


---

## How to `drake`

--

&lt;br&gt;

1) Store **prework** (your functions and any packages you need to load) in a file 

`prework.R`


--

2) Store a `drake` **plan** in another file


```r
plan &lt;- 
  drake_plan(
    cleaned_data = clean_my(raw_data),
    results = analyze_my(cleaned_data),
    report = report_out_my(results)
  )
```


--

3) **Run** the plan



```r
make(plan)
```

---

## What `drake does`


```r
plan &lt;- 
  drake_plan(
    cleaned_data = clean_my(raw_data),
    results = analyze_my(cleaned_data),
    report = report_out_my(results)
  )
```

`drake_plan` stores your plan as targets and commands in a dataframe.


```r
plan
## # A tibble: 3 x 2
##   target       command                 
##   &lt;chr&gt;        &lt;chr&gt;                   
## 1 cleaned_data clean_my(raw_data)      
## 2 results      analyze_my(cleaned_data)
## 3 report       report_out_my(results)
```


---

## What `drake does`


```r
plan &lt;- 
  drake_plan(
    cleaned_data = clean_my(raw_data),
    results = analyze_my(cleaned_data),
    report = report_out_my(results)
  )
```



```r
make(plan)
```


## What `drake does`

**First run** of `make(plan)`:

`drake` runs the plan from scratch

&lt;br&gt;

**Thereafter**:

`drake` will only rebuild targets that are out of date, and everything downstream of them



---

## What makes a target become out of date?

1) A trigger is activated (more on these later)


--

2) Some part of the code used to generate that target or one of its upstream targets has changed


```r
plan
## # A tibble: 3 x 2
##   target       command                 
##   &lt;chr&gt;        &lt;chr&gt;                   
## 1 cleaned_data clean_my(raw_data)      
## 2 results      analyze_my(cleaned_data)
## 3 report       report_out_my(results)
```


`drake` knows that`results` depends on the object `cleaned_data` and the function `analyze_my()`

because those are both part of the command used to generate `results`.

&lt;br&gt;

**So, if `cleaned_data` changes or `analyze_my` changes, `results` is out of date.**


---

## Where is all this info stored?

**targets**

In a hidden `.drake` directory, or cache. (You can check that it's there with `ls -a`.) [More on storage.](https://ropensci.github.io/drake/articles/storage.html)

`loadd()` loads targets from the cache into your R session.

`clean()` cleans the cache. (You can recover a cache if you clean it by accident.)

&lt;br&gt;

--

**dependencies**

`drake` hashes a target's dependencies to know when one of those dependencies changes, invalidating the target. 
You have [control](https://ropensci.github.io/drake/articles/storage.html#hash-algorithms) over the hashing algorithm used, location of the cache, etc.

`drake` stores a dependency graph (`igraph` object) of the plan along with a bunch of other things in a `config`.

You can access all of this with `drake_config()`.

---

## It's all about Functions

`drake` is all built around *functions* rather than scripts.

&lt;br&gt;

--

- A plan works by using functions to create targets

--

&lt;br&gt;

- This allows `drake` to infer **dependencies** between
  - objects and functions
  - functions and other functions

--

&lt;br&gt;

- Running `drake_plan` creates a dataframe relating each target to the command used to generate it

---

## All about Functions




```r
bad_plan &lt;- 
  drake_plan(
    first_target = source("import.R"),
    second_target = source("clean.R")
  )
```

--

Sourcing files breaks the dependency structure that makes `drake` useful. 

--

Instead, 


```r
source("all_my_funs.R")

good_plan &lt;- 
  drake_plan(
    first_target = do_stuff(my_data),
    second_target = do_more_stuff(first_target)
  )
```

Now `drake` knows`first_target` needs to be built before work on `second_target` can begin.

---

## Other things `drake` can do that we won't get into

- [Generate ~ big plans ~](https://ropensci.github.io/drake/articles/best-practices.html#generating-workflow-plan-data-frames)

.center[![big_plans](https://media.giphy.com/media/DCslYLxUUgKX2ms0iw/giphy.gif)]

for analyses that require lots of different permutations of a certain analysis.

(`drake` version 7.0.0 has a [new syntax](https://ropenscilabs.github.io/drake-manual/plans.html#create-large-plans-the-easy-way) that makes it easier to create big plans.)

- Support for [debugging and testing ](https://ropenscilabs.github.io/drake-manual/debug.html) plans

- Compatibility with [high performance computing](https://ropenscilabs.github.io/drake-manual/hpc.html) backends

---

## Moar Resources

&lt;br&gt;

- [`drake` user manual](https://ropenscilabs.github.io/drake-manual/index.html)

&lt;br&gt;

- [debugging drake](https://ropensci.github.io/drake/articles/debug.html)

&lt;br&gt;

- [Kirill MÃ¼ller's cheat sheet](https://github.com/krlmlr/drake-sib-zurich/blob/master/cheat-sheet.pdf)

&lt;br&gt;


- [Sina RÃ¼eger](https://sinarueeger.github.io/2018/10/09/workflow/) and [Christine Stawitz](https://github.com/cstawitz/RLadies_Sea_drake)'s `drake` presentations

&lt;br&gt;

- [Drake's Spotify station](https://open.spotify.com/artist/3TVXtAsR1Inumwj472S9r4)

---

background-image: url("https://static01.nyt.com/images/2018/12/29/nyregion/28xp-explosion-sub-print/28xp-explosion-sub-facebookJumbo.jpg)

## Our plan

Remember the [crazy blue light](https://twitter.com/NYCFireWire/status/1078478369036165121) from late December?

--

![](./img/blue_light.jpg)

--

Eeeek! ðŸ˜±

---

## Our plan

.pull-right[![](./img/nyc_fire.jpg)]

The Twitter account that let us know that this wasn't in fact aliens is [NYCFireWire](https://twitter.com/NYCFireWire).

&lt;br&gt;

Normally they just tweet out fires and their locations in a more or less predictable pattern:

&lt;br&gt;

&lt;br&gt;

&lt;br&gt;

&lt;br&gt;

`&lt;borough&gt; ** &lt;some numbers&gt; ** &lt;address&gt; &lt;description of fire&gt;`

&lt;br&gt;


We can analyze these tweets to get some info on fires in NYC.


???

I'll illustrate a way you might want to use `drake` with something that's close to home for us.

What if we were constructing an analysis of these tweets and wanted to make sure our pipeline worked end-to-end, but didn't want to unnecessarily re-run outdated parts of it unless we needed to?


---

## The Pipeline

1. Pull in tweets, either the first big batch or any new ones that show up
2. Extract addresses from the tweets (ðŸŽ¶ regex time ðŸŽ¶)
3. Send addresses to the Google Maps API to grab their latitudes and longitudes
4. Profit

&lt;br&gt;

All functions stored in [`didnt_start_it.R`](https://github.com/aedobbyn/nyc-fires/blob/master/R/didnt_start_it.R), which we'll source in now.


```r
source(here::here("R", "didnt_start_it.R"))
```

--

&lt;br&gt;

**Caveats**

This analysis relies on the [rtweet](https://github.com/mkearney/rtweet) and [ggmap](https://github.com/dkahle/ggmap) packages.

To be able to run it in full you'll need a [Twitter API access token](https://rtweet.info/articles/auth.html) and [Google Maps Geocoding API key](https://developers.google.com/maps/documentation/geocoding/intro#Geocoding).

---

## Grabbing tweets

`get_tweets`

*Main idea*:
- builds up a file of the most recent set of tweets from a given account

*Details*:
- if neither file nor tbl supplied as arguments, grabs an initial seed batch of tweets
- if either is supplied, checks for new tweets and grabs them if any
- spits out the latest to the same file



Most recent tweets from NYCFireWire:

```r
get_tweets(n_tweets_seed = 3)
## # A tibble: 3 x 5
##   text                  user_id status_id   created_at          screen_name
##   &lt;chr&gt;                 &lt;chr&gt;   &lt;chr&gt;       &lt;dttm&gt;              &lt;chr&gt;      
## 1 Queens *99-75-1326* â€¦ 560024â€¦ 1090392701â€¦ 2019-01-29 18:34:13 NYCFireWire
## 2 Brooklyn *77-75-3046â€¦ 560024â€¦ 1090356058â€¦ 2019-01-29 16:08:36 NYCFireWire
## 3 Brooklyn *77-75-1605â€¦ 560024â€¦ 1090330095â€¦ 2019-01-29 14:25:26 NYCFireWire
```

???

- `get_seed_tweets` grabs a batch of tweets *or* reads in seed tweets from a file if the file exists
- `get_more_tweets` checks if there are new tweets and, if so, pulls in the right number of them
- `get_tweets` runs `get_seed_tweets` if given a null `tbl` argument, otherwise runs `get_more_tweets`


---

## Grabbing seed tweets

A closer look at just the text of the tweets:


```r
get_tweets() %&gt;% 
  select(text) %&gt;% 
  kable(format = "html")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-1326* Hammel Houses 84-14 Rockaway Beach Bl. Compactor fire &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3046* 3602 Avenue J. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-1605* 1673 Carroll St. Fire top floor 2 story &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3646* 296 West end Ave off Orietal Blvd. Fire in a 3 story &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Weâ€™ll have a cure for cancer within a year, scientists claim https://t.co/wtiN92bdRz &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Someone got access to NNSS in Nevada. I was there last year taking the Rad/Nuc course. This is a heavily secured site. Not a good move. https://t.co/pCBIRIPUx9 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-1597* 260 Convent Ave. Fire 2nd floor. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-9625* 107-27 Atlantic Ave. Fire 2nd floor mixed occupancy. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Prayers for Houston Police https://t.co/pkaKLffji2 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-1587* 240 W 139 St off Powell. E-69 transmitting the 10-75 for a garage fire in the rear. &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;


---

## Reupping tweets

Starting with an old tweet ID, we can first grab a 10 tweets older than `old_tweet_id` and then, running the same function again, add 5 of the most recent tweets to our dataframe.


```r
old_tweet_id &lt;- "1084619203167031297" # Random tweet from a while ago so what we can set a max id in the past

seed_tweets &lt;- 
  get_tweets(
    n_tweets_seed = 10,
    max_id = old_tweet_id
  )

full_tweets &lt;- 
  get_tweets(seed_tweets, 
             n_tweets_reup = 5)
## Searching for new tweets.
## 5 new tweet(s) pulled.

nrow(seed_tweets)
## [1] 10
nrow(full_tweets)
## [1] 15
```

---

## Getting addresses

With `pull_addresses` we parse the text of the tweet to pull out borough and street and string them together into an address.




```r
get_tweets() %&gt;% 
  pull_addresses() %&gt;% 
  select(street, borough, address, text) %&gt;% 
  kable(format = "html")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; street &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; borough &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; address &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; text &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Hammel Houses 84-14 Rockaway Beach Bl &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Hammel Houses 84-14 Rockaway Beach Bl, Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-1326* Hammel Houses 84-14 Rockaway Beach Bl. Compactor fire &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 3602 Avenue J &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 3602 Avenue J, Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3046* 3602 Avenue J. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 1673 Carroll St &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1673 Carroll St, Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-1605* 1673 Carroll St. Fire top floor 2 story &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 296 West end Ave off Orietal Blvd &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 296 West end Ave off Orietal Blvd, Brooklyn &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Brooklyn *77-75-3646* 296 West end Ave off Orietal Blvd. Fire in a 3 story &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Weâ€™ll have a cure for cancer within a year, scientists claim https://t.co/wtiN92bdRz &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Someone got access to NNSS in Nevada. I was there last year taking the Rad/Nuc course. This is a heavily secured site. Not a good move. https://t.co/pCBIRIPUx9 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 260 Convent Ave &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 260 Convent Ave, Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-1597* 260 Convent Ave. Fire 2nd floor. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 107-27 Atlantic Ave &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 107-27 Atlantic Ave, Queens &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Queens *99-75-9625* 107-27 Atlantic Ave. Fire 2nd floor mixed occupancy. &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Prayers for Houston Police https://t.co/pkaKLffji2 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; 240 W 139 St off Powell &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 240 W 139 St off Powell, Manhattan &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Manhattan *66-75-1587* 240 W 139 St off Powell. E-69 transmitting the 10-75 for a garage fire in the rear. &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

## Getting lat and long

Final step of the main pipeline, now that we can pull addresses from tweets.

**Reverse geocoding** = getting latitude and longitude from an address.

The `ggmap` package exposes this feature of the [Google Maps](https://cloud.google.com/maps-platform/) API in their [`geocode`](https://www.rdocumentation.org/packages/ggmap/versions/2.6.1/topics/geocode) function.

If Google can't find the address, we return `NA`s.





```r
get_tweets(n_tweets_seed = 5) %&gt;% 
  pull_addresses() %&gt;% 
  get_lat_long()
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=Hammel%20Houses%2084-14%20Rockaway%20Beach%20Bl%2C%20Queens&amp;key=xxx
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=3602%20Avenue%20J%2C%20Brooklyn&amp;key=xxx
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=1673%20Carroll%20St%2C%20Brooklyn&amp;key=xxx
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=296%20West%20end%20Ave%20off%20Orietal%20Blvd%2C%20Brooklyn&amp;key=xxx
## # A tibble: 5 x 7
##   address      lat  long lat_trunc long_trunc created_at          text     
##   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;dttm&gt;              &lt;chr&gt;    
## 1 Hammel Hoâ€¦  40.6 -73.8      40.6      -73.8 2019-01-29 18:34:13 Queens *â€¦
## 2 3602 Avenâ€¦  40.6 -73.9      40.6      -73.9 2019-01-29 16:08:36 Brooklynâ€¦
## 3 1673 Carrâ€¦  40.7 -73.9      40.7      -73.9 2019-01-29 14:25:26 Brooklynâ€¦
## 4 296 West â€¦  40.6 -74.0      40.6      -74   2019-01-29 11:16:26 Brooklynâ€¦
## 5 &lt;NA&gt;        NA    NA        NA         NA   2019-01-29 07:39:31 Weâ€™ll haâ€¦
```


---

## Analysis chunks of the pipeline

Later in the pipeline we can join on some `ggplot2::map_data`


```r
(nyc &lt;-
  ggplot2::map_data("state", region = "new york") %&gt;%
  truncate_lat_long(digits = 1) %&gt;%
  as_tibble())
```


or `count_fires`, summing up the total number of fires per `lat`-`long` combo.


```r
count_fires &lt;- function(tbl) {
  tbl %&gt;%
    drop_na() %&gt;%
    group_by(lat, long) %&gt;%
    count()
}
```


---

## Quick benchmark

So where does `drake` really come in handy here?

Even though it didn't take too long to pull 5 tweets from Twitter and send 5 addresses to Google Maps, we wouldn't want to re-run this part of the pipeline every time we changed an analysis step.



```r
b_mark &lt;-
  bench::mark({
    get_tweets(n_tweets_seed = 1) %&gt;% 
    pull_addresses() %&gt;% 
    get_lat_long()
})
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=Hammel%20Houses%2084-14%20Rockaway%20Beach%20Bl%2C%20Queens&amp;key=xxx
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=Hammel%20Houses%2084-14%20Rockaway%20Beach%20Bl%2C%20Queens&amp;key=xxx
## Source : https://maps.googleapis.com/maps/api/geocode/json?address=Hammel%20Houses%2084-14%20Rockaway%20Beach%20Bl%2C%20Queens&amp;key=xxx

(our_bench &lt;- b_mark %&gt;% 
  select(median))
## # A tibble: 1 x 1
##     median
##   &lt;bch:tm&gt;
## 1    288ms
```


---

## Quick benchmark

How many **minutes** would the pipeline take for 3k tweets?


```r
(n_mins &lt;- (as.numeric(our_bench$median) # as.numeric returns seconds
 * 3000) / # 3k tweets
  60) # 60 seconds in a minute
## [1] 14.38912
```

&lt;br&gt;

All our downstream mapping and counting analysis depends on these trips to and from Twitter and Google.

If we tweak our code and want to make sure we can still run these downstream analyses on the most recent data,

`drake` will save us **14 minutes** of our lives *and* we'll still rest assured that our downstream targets have the most up to date data.


---

## Live coding time!

We'll set up the `drake` plan and run it for real. 

An exclusive sneak peek:


```r
plan &lt;-
  drake_plan(
    seed_fires = get_tweets( 
      n_tweets_seed = 2,
      max_id = old_tweet_id,
      input_path = fire_path
    ), 
    fires = target(
      command = get_tweets(
        tbl = seed_fires,
        n_tweets_reup = 3,
        output_path = fire_path
      ),
      trigger = trigger(
        condition = TRUE # Always look for new tweets
      )
    ),
    addresses = pull_addresses(fires), # Extract addresses from tweets
    lat_long = get_lat_long(addresses), # Send to Google for lat-longs
    dat = join_on_city_data(lat_long, nyc), # Join on the nyc coords
    fire_sums = count_fires(dat), # Sum up n fires per lat-long combo

    time_graph = graph_fire_times(dat),
    plot = plot_fire_sums(dat, nyc)
  )
```


---

## Live coding time!

The `rtweet` package also supports posting tweets, so we can test out whether our trigger successfully pulls in new tweet by posting ourselves with a



## ðŸ”¥ **[burner account!](https://twitter.com/didntstartit)** ðŸ”¥

&lt;br&gt;

Okay on to [part 2](https://github.com/aedobbyn/nyc-fires/blob/master/live_code.md) after this message from our sponsor.
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
